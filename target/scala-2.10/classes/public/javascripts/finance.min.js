$(function(){var folders={};var selectedFolderObj;var listFolders=function(){jsRoutes.controllers.FinanceFolderController.listFolders().ajax({success:function(data){addFoldersNode(data);$.each(data,function(i,folder){folders[folder.id]=folder})}})};var addFolder=function(event){if($("#newFolder").length==0){$("#folder-list").append("\x3cli\x3e"+"\x3cdiv class\x3d'input-group btn-group'\x3e"+"\x3cinput type\x3d'text' name\x3d'name' id\x3d'newFolder' value\x3d'new folder"+$("#folder-list").children().length+
"' class\x3d'form-control'\x3e"+"\t\x3cspan class\x3d'input-group-btn'\x3e\x3cbutton id\x3d'saveFolder' class\x3d'btn btn-info ' type\x3d'button'\x3e\x3cspan class\x3d'glyphicon glyphicon-ok'\x3e\x3c/span\x3e\x3c/button\x3e"+" \x3cbutton id\x3d'cancelFolder' class\x3d'btn btn-info cancel' type\x3d'button'\x3e\x3cspan class\x3d'glyphicon glyphicon-remove'\x3e\x3c/span\x3e\x3c/button\x3e"+"\x3c/span\x3e"+"\x3c/div\x3e"+"\x3c/li\x3e");$("#newFolder").focus()}else alert("Currently adding new folder. Must save it first")};
var saveFolder=function(e){var folderName=$("#newFolder").val();jsRoutes.controllers.FinanceFolderController.addFolder().ajax({data:{name:folderName},success:function(data){$("#newFolder").parent().parent().remove();folders[data.id]=data;addFoldersNode(data);$("#folder-list li[data-id\x3d"+data.id+"]").click()},error:function(data){alert("error adding folder")}})};var addFoldersNode=function(data){var html=[];if(Array.isArray(data))$.each(data,function(i,folder){html.push("\x3cli class\x3d'folder' data-id\x3d'"+
folder.id+"'\x3e"+"\x3ca class \x3d'folder-name' \x3e"+folder.name+"\x3cspan class\x3d'folderTotal'\x3e"+"  \x26ndash; $"+folder.total+"\x3c/span\x3e"+"\x3c/a\x3e"+"\x3c/li\x3e")});else html.push("\x3cli class\x3d'folder' data-id\x3d'"+data.id+"'\x3e"+"\x3ca class \x3d'folder-name' \x3e"+data.name+"\x3cspan class\x3d'folderTotal'\x3e"+"  \x26ndash; $"+data.total+"\x3c/span\x3e"+"\x3c/a\x3e"+"\x3c/li\x3e");$("#folder-list").append(html.join(""))};var updateFolder=function(event){};var deleteFolder=
function(event){var folderNode=$(".selected");var folderId=parseInt(folderNode.attr("data-id"));var folderNodeIndex=folderNode.index();var newSelected=$("#folder-list").children()[folderNodeIndex+1];if(!newSelected)newSelected=$("#folder-list").children()[folderNodeIndex-1];jsRoutes.controllers.FinanceFolderController.deleteFolder(folderId).ajax({success:function(data){delete folders.folderNodeIndex;folderNode.remove();if(newSelected!=null)newSelected.click();else{$("#transaction-table").css("display",
"none");$("#expense-descript").css("display","")}},error:function(data){alert("Could not delete Folder")}})};var selectFolder=function(event){var selected=$(".selected");if(this!=selected[0]){$("#expense-descript").css("display","none");selected.removeClass("selected");$(this).addClass("selected");var folderId=$(".selected").attr("data-id");$.each(folders,function(i,folder){if(folder.id==folderId)selectedFolderObj=folder});displayTransactions(selectedFolderObj);$("#transaction-table").css("display",
"");addTableSorter()}};var displayTransactions=function(folder){var html=[];$.each(folder.transactions,function(i,transaction){html.push(generateTransactionNode(transaction))});$("#transaction-table tbody").html(html.join(""));$(".datepicker").datepicker();updateSelectedFolderTotal()};var generateTransactionNode=function(transaction){var date=new Date(transaction.creationDate);var returnTransaction="\x3ctr data-id\x3d'"+transaction.id+"' class\x3d'viewRow'\x3e"+"\x3ctd class\x3d'actionBox'\x3e\x3cinput type\x3d'checkbox'\x3e\x3c/td\x3e"+
"\x3ctd class\x3d'transDate' \x3e"+(date.getUTCMonth()+1)+"/"+date.getUTCDate()+"/"+date.getUTCFullYear()+"\x3c/td\x3e \x3ctd class\x3d'transDescript'\x3e"+transaction.shortDescription+"\x3c/td\x3e\x3ctd class\x3d'transAmount'\x3e"+transaction.amount.toFixed(2)+"\x3c/td\x3e\x3c/tr\x3e";returnTransaction+=generateTransFormNode(transaction);return returnTransaction};var generateTransFormNode=function(transaction){var node;if(transaction){var date=new Date(transaction.creationDate);node="\x3ctr data-id\x3d'"+
transaction.id+"' class\x3d'updateRow' style\x3d'display: none'\x3e"+"\x3ctd\x3e \x3cdiv class\x3d'btn-group btn-group-sm'\x3e"+"\t\x3cbutton class\x3d'btn btn-info save' type\x3d'button'\x3e\x3cspan class\x3d'glyphicon glyphicon-ok'\x3e\x3c/span\x3e\x3c/button\x3e"+"\t\x3cbutton class\x3d'btn btn-info cancel' type\x3d'button'\x3e\x3cspan class\x3d'glyphicon glyphicon-remove'\x3e\x3c/span\x3e\x3c/button\x3e"+"\x3c/div\x3e\x3c/td\x3e"+"\x3ctd class\x3d'transDate' sorttable_customkey\x3d'"+(date.getUTCMonth()+
1)+"/"+date.getUTCDate()+"/"+date.getUTCFullYear()+"'\x3e"+"\x3cinput type\x3d'text' size\x3d'15' class\x3d'form-control datepicker ' value\x3d'"+(date.getUTCMonth()+1)+"/"+date.getUTCDate()+"/"+date.getUTCFullYear()+"'\x3e"+"\x3c/td\x3e \x3ctd class\x3d'transDescript' sorttable_customkey\x3d'"+transaction.shortDescription+"'\x3e"+"\x3cinput type\x3d'text' class\x3d'form-control ' value\x3d'"+transaction.shortDescription+"'\x3e"+"\x3c/td\x3e\x3ctd class\x3d'transAmount' sorttable_customkey\x3d'"+
transaction.amount.toFixed(2)+"'\x3e"+"\x3cinput type\x3d'text' size\x3d'10' class\x3d'form-control ' value\x3d'"+transaction.amount.toFixed(2)+"'\x3e"+"\x3c/td\x3e\x3c/tr\x3e"}else node="\x3ctr class\x3d'addRow'\x3e"+"\x3ctd\x3e \x3cdiv class\x3d'btn-group btn-group-sm'\x3e"+"\t\x3cbutton class\x3d'btn btn-info save' type\x3d'button'\x3e\x3cspan class\x3d'glyphicon glyphicon-ok'\x3e\x3c/span\x3e\x3c/button\x3e"+"\t\x3cbutton class\x3d'btn btn-info cancel' type\x3d'button'\x3e\x3cspan class\x3d'glyphicon glyphicon-remove'\x3e\x3c/span\x3e\x3c/button\x3e"+
"\x3c/div\x3e\x3c/td\x3e"+"\x3ctd class\x3d'transDate' \x3e"+"\x3cinput type\x3d'text' size\x3d'15' class\x3d'form-control datepicker'\x3e"+"\x3c/td\x3e \x3ctd class\x3d'transDescript'\x3e"+"\x3cinput type\x3d'text' class\x3d'form-control '\x3e"+"\x3c/td\x3e\x3ctd class\x3d'transAmount'\x3e"+"\x3cinput type\x3d'text' size\x3d'10' class\x3d'form-control '\x3e"+"\x3c/td\x3e\x3c/tr\x3e";return node};var addTransCallback=function(event){var row=generateTransFormNode();$("#transaction-table tbody").prepend(row);
$(".addRow .datepicker").datepicker()};var addTransaction=function(row){jsRoutes.controllers.TransactionController.addTransaction(selectedFolderObj.name).ajax({data:{amount:parseFloat($(".transAmount input",row).val()),shortDescription:$(".transDescript input",row).val(),creationDate:$(".transDate input",row).val()},success:function(data){var html=generateTransactionNode(data);$("#transaction-table tbody").prepend(html);updateFolderTransactions(data);removeFormView(null,row);$(".updateRow[data-id\x3d'"+
data.id+"'] .datepicker").datepicker();updateTableSort(false)},error:function(data){alert("cannot add transaction")}})};var deleteTransCallback=function(event){var transactionIds=[];$("#transaction-table .actionBox input[type\x3dcheckbox]:checked").each(function(i,checkbox){transactionIds.push($(checkbox).closest("tr").attr("data-id"))});if(transactionIds.length>0){var confirmed=confirm("Delete "+transactionIds.length+" transaction(s)?");if(confirmed)for(var i$$0=0;i$$0<transactionIds.length;i$$0++)jsRoutes.controllers.TransactionController.deleteTransaction(transactionIds[i$$0]).ajax({success:function(data){var removedIndexes=
[];$("#transaction-table tr[data-id\x3d'"+data.id+"']").remove();selectedFolderObj.total-=data.amount;$.each(selectedFolderObj.transactions,function(i,transaction){if(transaction.id==data.id)removedIndexes.push(i)});$.each(removedIndexes,function(i,index){selectedFolderObj.transactions.splice(index,1)});updateSelectedFolderTotal();updateTableSort(false)}})}};var updateTransCallback=function(event){var transactionIds=[];$("#transaction-table input[type\x3dcheckbox]:checked").each(function(i,checkbox){transactionIds.push($(checkbox).closest("tr").attr("data-id"))});
if(transactionIds.length>0)$.each(transactionIds,function(i,transaction){$(".viewRow[data-id\x3d'"+transaction+"']").css("display","none");$(".updateRow[data-id\x3d'"+transaction+"']").css("display","")})};var saveRow=function(event){var row=$(this).parent().parent().parent();if(row.hasClass("updateRow"))updateTransaction(row);else if(row.hasClass("addRow"))addTransaction(row)};var updateTransaction=function(updatedRow){var transactionId=updatedRow.attr("data-id");var viewRow=$(".viewRow[data-id\x3d'"+
transactionId+"']");jsRoutes.controllers.TransactionController.updateTransaction(transactionId).ajax({data:{amount:parseFloat($(".transAmount input",updatedRow).val()),shortDescription:$(".transDescript input",updatedRow).val(),creationDate:$(".transDate input",updatedRow).val()},success:function(data){console.log("updated amount: "+data.amount);var oldAmount=$(".transAmount ",viewRow)[0].innerHTML;var date=new Date(data.creationDate);$(".transAmount",viewRow)[0].innerHTML=data.amount.toFixed(2);
$(".transDescript",viewRow)[0].innerHTML=data.shortDescription;$(".transDate ",viewRow)[0].innerHTML=date.getUTCMonth()+1+"/"+date.getUTCDate()+"/"+date.getUTCFullYear();$(".transAmount",updatedRow).attr("sorttable_customkey",data.amount.toFixed(2));$(".transDescript",updatedRow).attr("sorttable_customkey",data.shortDescription);$(".transDate",updatedRow).attr("sorttable_customkey",date.getUTCMonth()+1+"/"+date.getUTCDate()+"/"+date.getUTCFullYear());updateFolderTransactions(data);removeFormView(event,
updatedRow);updateTableSort(true)},error:function(data){alert("cannot update transaction")}})};var removeFormView=function(event,row){if(row==null)row=$(this).parent().parent().parent();if(row.hasClass("updateRow")){var transactionId=row.attr("data-id");var viewRow=$(".viewRow[data-id\x3d'"+transactionId+"']");$(".transDate input",row).val($(".transDate",viewRow).html());$(".transAmount input",row).val($(".transAmount",viewRow).html());$(".transDescript input",row).val($(".transDescript",viewRow).html());
$(row).css("display","none");$(viewRow).css("display","");$("input[type\x3dcheckbox]",viewRow).prop("checked",false)}else row.remove()};var updateFolderTransactions=function(newTransaction){var oldAmount=0;var containsTrans=false;$.each(selectedFolderObj.transactions,function(i,transaction){if(transaction.id==newTransaction.id){oldAmount=transaction.amount;transaction.creationDate=newTransaction.creationDate;transaction.shortDescription=newTransaction.shortDescription;transaction.amount=newTransaction.amount;
containsTrans=true}});if(!containsTrans)selectedFolderObj.transactions.push(newTransaction);selectedFolderObj.total+=newTransaction.amount-oldAmount;updateSelectedFolderTotal()};var updateSelectedFolderTotal=function(){$(".selected .folderTotal")[0].innerHTML="  \x26ndash; $"+selectedFolderObj.total.toFixed(2)};var addTableSorter=function(){$("#transaction-table").tablesorter({textExtraction:function(node){var customKey=$(node).attr("sorttable_customkey");return customKey||node.innerHTML},headers:{0:{sorter:false}},
sortList:[[1,0]]})};var updateTableSort=function(resort){var table=$("#transaction-table");table.trigger("update",[resort])};$("#transaction-table").on("click","#delete",deleteTransCallback);$("#transaction-table").on("click","#updateButton",updateTransCallback);$("#transaction-table").on("click","#add",addTransCallback);$("#transaction-table").on("click",".save",saveRow);$("#transaction-table").on("click",".cancel",removeFormView);$("#transaction-table").css("display","none");$("#folder-list").on("click",
".cancel",removeFormView);$("#addFolder").on("click",addFolder);$("#deleteFolder").on("click",deleteFolder);$("#updateFolder").on("click",updateFolder);$("#folder-list").on("click",".folder",selectFolder);$("#folder-list").on("click","#saveFolder",saveFolder);listFolders()});